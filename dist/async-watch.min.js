function dotNotation(n){if(n instanceof Array)return{path:n,str:n.join(".")};if("string"==typeof n)return{path:n.split("."),str:n}}function getPropertyValue(n,t){if(0!==t.length&&void 0!==n){var e=dotNotation(t);if(e){t=e.path;for(var s=0;s<t.length;s++)if(n=n[t[s]],void 0===n)return;return n}}}function setHiddenProperty(n,t,e){return Object.defineProperty(n,t,{enumerable:!1,value:e}),e}var isNode="undefined"!=typeof module&&module.exports&&"object"==typeof process&&"undefined"==typeof window,nextTick=isNode?process.nextTick:window.requestAnimationFrame,fnIdCounter=0,AsyncTransaction={jobs:{},_signed:{},subscriptions:{},scheduled:!1,__subscribers:function(n){for(var t in n)if(n.hasOwnProperty(t)){n[t].fn.apply(null,[n[t].values])}},__digest:function(){var n=this;n.scheduled===!1&&(n.scheduled=!0,nextTick(function(){n.scheduled=!1;for(var t in n.jobs)n.jobs[t](),delete n.jobs[t];var e={};for(var t in n._signed){var s=n._signed[t],r=s.target();if(s.signed.apply(null,r),n.subscriptions[t]){var i=n.subscriptions[t].$id;e[i]=e[i]||{values:{},fn:n.subscriptions[t]},e[i].values[s.signed.$path]=r[0]}delete n._signed[t]}n.__subscribers(e)}))},signFunction:function(n){n.$id=n.$id||fnIdCounter++},subscribe:function(n,t){this.signFunction(t);for(var e=0;e<n.length;e++){var s=n[e];this.subscriptions[s.fn.$id]=t}},unsubscribe:function(n){for(var t=0;t<n.length;t++){var e=n[t];delete this.subscriptions[e.fn.$id]}},sign:function(n,t){return this.signFunction(n),n.$instant?n.apply(null,t()):(this._signed[n.$id]={target:t,signed:n},this.__digest())},cancel:function(n){delete this._signed[n.$id]},add:function(n,t,e){return t=e?t.bind(e):t,this.jobs[n]=t,this.__digest()}},Subscribe=function(n,t){return AsyncTransaction.subscribe(n,t),{unsubscribe:function(){return AsyncTransaction.unsubscribe(n)},destroy:function(){AsyncTransaction.unsubscribe(n);for(var t in n){var e=n[t];e.destroy()}}}},idCounter=0,AsyncWatch=function(n,t,e,s){if("object"==typeof n&&"function"==typeof e){var r=dotNotation(t);if(r){e.$id=e.$id||fnIdCounter++,s&&(e.$instant=!0);var i=r.path,a=r.str;e.$path=a;for(var c=i[0],o=[],u=0;u<i.length;u++)o.push(i[u]);var d,f=o.splice(1,o.length),p=f.join("."),h=c===a,y=n.$$p;y||(setHiddenProperty(n,"$$p",{}),y=n.$$p,setHiddenProperty(y,"$properties",{}),setHiddenProperty(y,"$id",++idCounter)),void 0===d&&(d=y.$id);var l=y.$properties[c];if(!l){l=y.$properties[c]={$self:[],$descendants:{}};var b=n[c];Object.defineProperty(n,c,{get:function(){return b},set:function(n){return $(n,b),b=n}});var $=function(n,t){for(var e in l.$descendants)if(l.$descendants.hasOwnProperty(e)){for(var s in l.$descendants[e].callbacks){var r=l.$descendants[e].callbacks[s];AsyncTransaction.sign(r,function(){return[getPropertyValue(n,e),t]})}AsyncTransaction.add(d+e,function(){l.$descendants[this.key].bindWatcher()},{key:e})}if(h)for(var s=0;s<l.$self.length;s++){var i=l.$self[s];i.$path&&"object"==typeof t&&(t=getPropertyValue(t,i.$path)),AsyncTransaction.sign(i,function(){return[n,t]})}}}h?(AsyncTransaction.sign(e,function(){return[n[c]]}),l.$self.push(e)):(l.$descendants[p]?l.$descendants[p].callbacks.push(e):(l.$descendants[p]={callbacks:[e],bindWatcher:function(){n.hasOwnProperty(c)&&void 0!==n[c]&&AsyncWatch(n[c],f,function(n,t){for(var e=0;e<l.$descendants[p].callbacks.length;e++){var s=l.$descendants[p].callbacks[e];AsyncTransaction.sign(s,function(){return[n,t]})}},!0)}},l.$descendants[p].bindWatcher()),AsyncTransaction.sign(e,function(){return[getPropertyValue(n[c],f)]}));var v=l.$descendants[p];return{fn:e,destroy:function(){if(v){var n=v.callbacks.indexOf(e);n>-1&&v.callbacks.splice(n,1)}if(l.$self){var t=l.$self.indexOf(e);t>-1&&l.$self.splice(n,1)}}}}}},AsyncComputed=function(n,t,e,s){for(var r=[],i=0;i<e.length;i++){var a=e[i];r.push(AsyncWatch(n,a,function(){}))}return Subscribe(r,function(){n[t]=s.bind(n)(n)})},AsyncWatchArray=function(n,t,e,s){var r=[];return AsyncWatch(n,t,function(n,t){n.$$p||(n.$$p=p=setHiddenProperty(n,"$pp",{}));var s=n.$$p.array;return s||(s=setHiddenProperty(p,"array",{})),s.watchers||(s.watchers=setHiddenProperty(s,"fn",[])),s.watchers.push(e),s.init||(s.init=!0,s.changed=function(t){if(t.length>0)for(var e=0;e<s.watchers.length;e++)s.watchers[e](n,r);r=[]},n.push=function(){Array.prototype.push.apply(this,arguments);var n=arguments;r.push({name:"push",data:n}),AsyncTransaction.sign(s.changed,function(){return[r]})},n.shift=function(){var n=arguments;Array.prototype.shift.apply(this,arguments),r.push({name:"shift",data:n}),AsyncTransaction.sign(s.changed,function(){return[r]})},n.splice=function(){var n=arguments;Array.prototype.splice.apply(this,arguments),r.push({name:"splice",data:n}),AsyncTransaction.sign(s.changed,function(){return[r]})},n.unshift=function(){var n=arguments;Array.prototype.unshift.apply(this,n),r.push({name:"unshift",data:n}),AsyncTransaction.sign(s.changed,function(){return[r]})}),r=[],e(n,[{name:"init"}])},s)};AsyncWatch.subscribe=Subscribe,AsyncWatch.computed=AsyncComputed,module.exports.AsyncWatch=AsyncWatch,module.exports.AsyncSubscribe=Subscribe,module.exports.AsyncComputed=AsyncComputed,module.exports.AsyncWatchArray=AsyncWatchArray,module.exports.AsyncTransaction=AsyncTransaction;